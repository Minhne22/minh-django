<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Links</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h3>üîó Qu·∫£n l√Ω Links Onüü¢</h3>

        <!-- B·ªô l·ªçc -->
        <div class="mb-3">
            <label>Username:</label>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="usernameDropdown">
                    Ch·ªçn Username
                </button>
                <ul class="dropdown-menu" id="filterUsername"></ul>
            </div>

            <label for="filterTimeRange">Th·ªùi gian comment cu·ªëi (gi·ªù):</label>
            <div class="d-flex gap-2">
                <input type="number" id="filterTimeMin" class="form-control" placeholder="T·ª´ gi·ªù">
                <input type="number" id="filterTimeMax" class="form-control" placeholder="ƒê·∫øn gi·ªù">
            </div>

            <label for="filterType">Lo·∫°i:</label>
            <select id="filterType" class="form-select">
                <option value="">T·∫•t c·∫£</option>
                <option value="public">Public</option>
                <option value="private">Private</option>
            </select>

            <button id="applyFilter" class="btn btn-primary mt-2">L·ªçc</button>
            <button id="selectAllPosts" class="btn btn-secondary mt-2">Ch·ªçn T·∫•t C·∫£</button>
            <button id="deleteSelected" class="btn btn-danger mt-2">X√≥a nh·ªØng b√†i ƒë√£ ch·ªçn</button>
        </div>

        <!-- B·∫£ng Links -->
        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>STT</th>
                    <th>Username</th>
                    <th>Time Created</th>
                    <th>ID Post</th>
                    <th>T√™n B√†i</th>
                    <th>Th·ªùi Gian Cmt Cu·ªëi</th>
                    <th>Count Cmt</th>
                    <th>Delay</th>
                    <th>Status</th>
                    <th>Active</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="linkTable"></tbody>
        </table>

        <!-- Modal Ch·ªânh s·ª≠a -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Ch·ªânh s·ª≠a Link</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editPostId">

                        <div class="mb-3">
                            <label for="editPostName" class="form-label">T√™n b√†i</label>
                            <input type="text" class="form-control" id="editPostName">
                        </div>

                        <div class="mb-3">
                            <label for="editContent" class="form-label">N·ªôi dung</label>
                            <textarea class="form-control" id="editContent" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="editDelay" class="form-label">Delay Time</label>
                            <input type="text" class="form-control" id="editDelay">
                        </div>

                        <div class="mb-3">
                            <label for="editStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStatus">
                                <option value="public">Public</option>
                                <option value="private">Private</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                        <button type="button" class="btn btn-primary" id="saveEdit">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            function getCsrfToken() {
                return $('input[name="csrfmiddlewaretoken"]').val();
            }

            $(document).on("click", ".toggle-active", function () {
                let button = $(this);
                let originUrl = button.data("origin-url");
                let user = button.data("user");
                let newActive = 'off'
            
                $.ajax({
                    url: "{% url 'toggle-active' %}",
                    type: "POST",
                    data: JSON.stringify({ origin_url: originUrl, active: newActive, username: user }),
                    contentType: "application/json",
                    headers: { "X-CSRFToken": getCsrfToken() },
                    success: function (response) {
                        if (response.success) {
                            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                            button.data("active", newActive);
                            button.toggleClass("btn-success btn-secondary");
                            button.text(newActive);
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function (response) {
                        alert(response.responseJSON.error);
                    }
                });
            });

            function loadUsernames() {
                $.get("{% url 'get_username' %}", function (data) {
                    let userContainer = $("#filterUsername");
                    userContainer.empty();
                    data.username.forEach(user => {
                        userContainer.append(`
                            <li>
                                <label class="dropdown-item">
                                    <input class="form-check-input me-2 user-checkbox" type="checkbox" value="${user}" checked> ${user}
                                </label>
                            </li>
                        `);
                    });
                });
            }

            $("#usernameDropdown").on("click", function (event) {
                event.stopPropagation();
                $("#filterUsername").toggle();
            });

            $(document).on("click", function (event) {
                if (!$(event.target).closest(".dropdown").length) {
                    $("#filterUsername").hide();
                }
            });

            function timeAgo(timestamp) {
                let hoursAgo = Math.floor((Date.now() / 1000 - timestamp) / 3600);
                return `${hoursAgo}h`;
            }

            function updateTable(data) {
                if (!Array.isArray(data)) {
                    console.error("Data is not an array:", data);
                    return;
                }
                let tableBody = $("#linkTable");
                tableBody.empty();
                data.forEach((link, index) => {
                    let postLink = `<a href="${link.origin_url}" target="_blank">${link.post_id}</a>`;
                    // let formattedLastCommentTime = link.last_comment_time === "Processing" ? "Processing" : calculateHoursAgo(link.last_comment_time);
                    var active = link.active;
                    if (active == 'pending'){
                        active = '‚è≥ Ch·ªù x·ª≠ l√Ω';
                    }
                    if (active == 'failed'){
                            active = '‚ùå Th·∫•t b·∫°i';
                        }
                    if (active == 'on'){
                            active = '‚úÖ ƒêang ch·∫°y';
                        }
                    if (active == 'off'){
                            active = '‚ö´ ƒê√£ t·∫Øt';}
                    tableBody.append(`
                        <tr>
                            <td><input type="checkbox" class="select-post" value="${link.post_id}"></td>
                            <td>${index + 1}</td>
                            <td>${link.username}</td>
                            <td>${link.created_time}</td>
                            <td><a href="${link.origin_url}" target="_blank">${link.post_id}</a></td>
                            <td>
                                <span data-bs-toggle="tooltip" title="${link.content}">
                                    ${link.name}
                                </span>
                            </td>
                            <td>${timeAgo(link.last_comment_time)}</td>
                            <td>${link.comment_count}</td>
                            <td>${link.delay}</td>
                            <td>${link.status}</td>
                            <td>
                                <button class="btn btn-sm toggle-active" data-origin-url="${link.origin_url}" data-user="${link.username}">
                                    ${active}
                                </button>
                            </td>
                            <td>
                                <button class="btn btn-warning edit-link" data-post-id="${link.post_id}">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger delete-link" data-origin-url="${link.origin_url}">‚ùå X√≥a</button>
                            </td>
                        </tr>
                    `);
                });
            }

            

            $("#applyFilter").on("click", function () {
                let selectedUsernames = [];
                $(".user-checkbox:checked").each(function () {
                    selectedUsernames.push($(this).val());
                });
                
                let filterData = {
                    usernames: selectedUsernames,
                    min_time: $("#filterTimeMin").val(),
                    max_time: $("#filterTimeMax").val(),
                    type: $("#filterType").val()
                };
                
                $.ajax({
                    url: "{% url 'get_links_on' %}",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(filterData),
                    headers: { "X-CSRFToken": getCsrfToken() },
                    success: function (response) {
                        updateTable(response.links);
                    }
                });
            });

            // Ch·ª©c nƒÉng ch·ªçn t·∫•t c·∫£ b√†i vi·∫øt
            $("#selectAll").on("change", function () {
                $(".select-post").prop("checked", this.checked);
            });

            $("#selectAllPosts").on("click", function () {
                let allChecked = $(".select-post:checked").length === $(".select-post").length;
                $(".select-post").prop("checked", !allChecked);
                $("#selectAll").prop("checked", !allChecked);
            });

            // Ch·ª©c nƒÉng x√≥a b√†i vi·∫øt ƒë√£ ch·ªçn
            $("#deleteSelected").on("click", function () {
                let selectedPosts = [];
                $(".select-post:checked").each(function () {
                    selectedPosts.push({
                        post_id: $(this).val(),
                        origin_url: $(this).closest("tr").find("a").attr("href")
                    });
                });

                if (selectedPosts.length === 0) {
                    alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt b√†i ƒë·ªÉ x√≥a!");
                    return;
                }

                if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh·ªØng b√†i ƒë√£ ch·ªçn?")) return;

                $.ajax({
                    url: "{% url 'delete_posts' %}",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ posts: selectedPosts }),
                    headers: { "X-CSRFToken": getCsrfToken() },
                    success: function () {
                        alert("ƒê√£ x√≥a th√†nh c√¥ng!");
                        $("#applyFilter").click(); // T·∫£i l·∫°i d·ªØ li·ªáu sau khi x√≥a
                    },
                    error: function () {
                        alert("X√≥a th·∫•t b·∫°i!");
                    }
                });
            });

            loadUsernames();
        });
    </script>
</body>
</html>
