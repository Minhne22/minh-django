<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Links</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h3>üîó Qu·∫£n l√Ω Links Onüü¢</h3>

        <!-- Box hi·ªÉn th·ªã s·ªë links ƒë√£ c√≥ / limit_on -->
        <div class="alert alert-info" role="alert">
            <span id="linksCount">0</span> / <span id="limitOn">0</span> Links
        </div>

        <!-- Th√™m Link -->
        <div class="mb-3">
            <label for="multiLinks">Nh·∫≠p nhi·ªÅu links (m·ªói d√≤ng m·ªôt link):</label>
            <textarea id="multiLinks" class="form-control" rows="5" placeholder="D√°n c√°c link v√†o ƒë√¢y, m·ªói d√≤ng m·ªôt link..."></textarea>
            <button id="addLinksBtn" class="btn btn-primary mt-2">
                ‚ûïTh√™m Links
                <span id="addLinksSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
            </button>
        </div>

        <!-- Spinner hi·ªÉn th·ªã khi ƒëang t·∫£i -->
        <div id="loadingSpinner" class="text-center my-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- B·∫£ng Links -->
        <table class="table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Time Created</th>
                    <th>ID Post</th>
                    <th>T√™n B√†i</th>
                    <th>Th·ªùi Gian Cmt Cu·ªëi</th>
                    <th>Count Cmt</th>
                    <th>Delay</th>
                    <th>Status</th>
                    <th>Active</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="linkTable"></tbody>
        </table>

        <!-- Modal Ch·ªânh s·ª≠a -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Ch·ªânh s·ª≠a Link</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editPostId">

                        <div class="mb-3">
                            <label for="editPostName" class="form-label">T√™n b√†i</label>
                            <input type="text" class="form-control" id="editPostName">
                        </div>

                        <div class="mb-3">
                            <label for="editContent" class="form-label">N·ªôi dung</label>
                            <textarea class="form-control" id="editContent" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="editDelay" class="form-label">Delay Time</label>
                            <input type="text" class="form-control" id="editDelay">
                        </div>

                        <div class="mb-3">
                            <label for="editStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStatus">
                                <option value="public">Public</option>
                                <option value="private">Private</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                        <button type="button" class="btn btn-primary" id="saveEdit">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            $(document).ready(function () {
                function loadLinks() {
                    $.get("{% url 'get_links_on' %}", function (data) {
                        let rows = "";
                        data.links.forEach((link, index) => {
                            let postLink = `<a href="${link.origin_url}" target="_blank">${link.post_id}</a>`;
                            let formattedLastCommentTime = link.last_comment_time === "Processing" ? "Processing" : calculateHoursAgo(link.last_comment_time);
                            var active = link.active;
                            if (active == 'pending'){
                                active = '‚è≥ Ch·ªù x·ª≠ l√Ω';
                            }
                            if (active == 'failed'){
                                    active = '‚ùå Th·∫•t b·∫°i';
                                }
                            if (active == 'on'){
                                    active = '‚úÖ ƒêang ch·∫°y';
                                }
                            if (active == 'off'){
                                    active = '‚ö´ ƒê√£ t·∫Øt';}
                            if (active == 'on'){
                                    active = '‚úÖ ƒêang ch·∫°y';
                                }
                            
                            rows += `<tr>
                                <td>${index + 1}</td>
                                <td>${formatDate(link.created_time)}</td>
                                <td>${postLink}</td>
                                <td>
                                    <span data-bs-toggle="tooltip" title="${link.content}">
                                        ${link.name}
                                    </span>
                                </td>
                                <td>${formattedLastCommentTime}</td>
                                <td>${link.comment_count}</td>
                                <td>${link.delay}</td>
                                <td>${link.status}</td>
                                <td>
                                    <button class="btn btn-sm toggle-active" data-post-id="${link.post_id}">
                                        ${active}
                                    </button>
                                </td>

                                <td>
                                    <button class="btn btn-warning edit-link" data-post-id="${link.post_id}">‚úèÔ∏è Edit</button>
                                    <button class="btn btn-danger delete-link" data-post-id="${link.post_id}">‚ùå X√≥a</button>
                                </td>
                            </tr>`;
                        });
                        $("#linkTable").html(rows);
                        updateLinksCount(data.links.length);
                    }).done(function () {
                        // BIND l·∫°i s·ª± ki·ªán click sau khi load data
                        bindEvents();
                    });
                }

                function bindEvents() {
                    // M·ªü modal ch·ªânh s·ª≠a
                    $(".edit-link").off("click").on("click", function () {
                        let post_id = $(this).data("post-id");

                        // L·∫•y th√¥ng tin t·ª´ b·∫£ng
                        let row = $(this).closest("tr");
                        $("#editPostId").val(post_id);
                        $("#editPostName").val(row.find("td:eq(3)").text());
                        $("#editContent").val(row.find("td:eq(3) span").attr("title"));
                        $("#editDelay").val(row.find("td:eq(6)").text());
                        $("#editStatus").val(row.find("td:eq(7)").text());

                        $("#editModal").modal("show");
                    });
                }

                function updateLinksCount(count) {
                    $("#linksCount").text(count);
                    $.get("{% url 'get_user_limit' %}", function (data) {
                        $("#limitOn").text(data.limit_on);
                    });
                }

                loadLinks();

                // Th√™m link
                $("#addLinksBtn").on("click", function () {
                    let links = $("#multiLinks").val().trim().split("\n").map(link => link.trim()).filter(link => link);

                    if (links.length === 0) {
                        alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt link!");
                        return;
                    }

                    $("#addLinksSpinner").show(); // Hi·ªán spinner

                    let tableBody = $("#linkTable");
                    links.forEach((link) => {
                        let newRow = `<tr data-post-id="">
                            <td>New</td>
                            <td>Processing...</td>
                            <td>${link}</td>
                            <td>Processing...</td>
                            <td>Processing...</td>
                            <td>Processing...</td>
                            <td>Processing...</td>
                            <td><span class="badge bg-warning">Processing</span></td>
                            <td>-</td>
                        </tr>`;
                        tableBody.append(newRow);
                    });

                    $.ajax({
                        url: "{% url 'add_links' %}",
                        type: "POST",
                        data: JSON.stringify({ links: links }),
                        contentType: "application/json",
                        headers: { "X-CSRFToken": getCSRFToken() },
                        success: function (response) {
                            if (response.success) {
                                reloadData();
                                document.getElementById('multiLinks').value = '';
                            }
                        },
                        complete: function () {
                            document.getElementById('multiLinks').value = '';
                            $("#addLinksSpinner").hide(); // ·∫®n spinner sau khi x·ª≠ l√Ω xong
                        },
                        error: function (response) {
                            console.log(response);
                            alert(response.responseJSON.error);
                        }
                    });
                });

                function getCSRFToken() {
                    return document.cookie.split('; ').find(row => row.startsWith('csrftoken'))?.split('=')[1];
                }

                function reloadData() {
                    $("#loadingSpinner").show(); // Hi·ªán spinner
                    $.ajax({
                        url: "{% url 'get_links_on' %}",
                        type: "GET",
                        success: function (response) {
                            if (response.success) {
                                let tableBody = $("#linkTable");
                                tableBody.empty();
                                response.links.forEach((link, index) => {
                                    let row = `<tr>
                                        <td>${index + 1}</td>
                                        <td>${formatDate(link.created_time)}</td>
                                        <td><a href="https://www.facebook.com/${link.post_id}" target="_blank">${link.post_id}</a></td>
                                        <td>
                                            <span data-bs-toggle="tooltip" title="${link.content}">
                                                ${link.name}
                                            </span>
                                        </td>
                                        <td>${link.last_comment_time === "Processing" ? "Processing" : calculateHoursAgo(link.last_comment_time)}</td>
                                        <td>${link.comment_count}</td>
                                        <td>${link.delay}</td>
                                        <td><span class="badge ${link.status === 'public' ? 'bg-success' : 'bg-danger'}">${link.status}</span></td>
                                        <td>
                                            <button class="btn btn-warning edit-link" data-post-id="${link.post_id}">Edit</button>
                                            <button class="btn btn-danger delete-link" data-post-id="${link.post_id}">Delete</button>
                                        </td>
                                    </tr>`;
                                    tableBody.append(row);
                                });

                                $('[data-bs-toggle="tooltip"]').tooltip(); // C·∫≠p nh·∫≠t tooltip
                                updateLinksCount(response.links.length);
                            }
                        },
                        complete: function () {
                            $("#loadingSpinner").hide(); // ·∫®n spinner sau khi load xong
                        },
                        error: function () {
                            alert("Kh√¥ng th·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu!");
                            $("#loadingSpinner").hide(); // ·∫®n spinner n·∫øu c√≥ l·ªói
                        }
                    });
                }

                // X√≥a link
                $(document).on("click", ".delete-link", function () {
                    let post_id = $(this).data("post-id");

                    $(this).html('‚ùå X√≥a <span class="spinner-border spinner-border-sm" role="status"></span>');

                    $.post("{% url 'delete_link' %}", JSON.stringify({ post_id: post_id }), function () {
                        reloadData();
                    }, "json").always(function () {
                        $(this).html('‚ùå X√≥a');
                    });
                });

                // M·ªü modal ch·ªânh s·ª≠a
                let editModal = new bootstrap.Modal(document.getElementById("editModal"));

                $(".edit-link").on("click", function () {
                    let row = $(this).closest("tr");

                    $("#editPostId").val($(this).data("post-id"));
                    $("#editPostName").val(row.find("td:eq(3)").text());
                    $("#editContent").val(row.find("td:eq(3) span").attr("title"));
                    $("#editDelay").val(row.find("td:eq(6)").text());
                    $("#editStatus").val(row.find("td:eq(7)").text());

                    editModal.show();
                });

                $("#saveEdit").on("click", function () {
                    let postId = $("#editPostId").val();
                    let newName = $("#editPostName").val();
                    let newContent = $("#editContent").val();
                    let newDelay = $("#editDelay").val();
                    let newStatus = $("#editStatus").val();

                    $.ajax({
                        url: "{% url 'edit_link' %}",
                        type: "POST",
                        data: JSON.stringify({
                            post_id: postId,
                            name: newName,
                            content: newContent,
                            delay: newDelay,
                            status: newStatus
                        }),
                        contentType: "application/json",
                        headers: { "X-CSRFToken": getCSRFToken() },
                        success: function (response) {
                            if (response.success) {
                                reloadData();
                                $("#editModal").modal("hide");
                            } else {
                                alert(response.error);
                            }
                        },
                        error: function () {
                            alert("L·ªói khi g·ª≠i d·ªØ li·ªáu!");
                        }
                    });
                });

                function getCSRFToken() {
                    return document.cookie.split('; ')
                        .find(row => row.startsWith('csrftoken'))
                        ?.split('=')[1];
                }

                function formatDate(timestamp) {
                    if (!isNaN(timestamp)) {
                        let date = new Date(timestamp * 1000);  // Convert UNIX timestamp to JavaScript Date object
                        let day = date.getDate().toString().padStart(2, '0');
                        let month = (date.getMonth() + 1).toString().padStart(2, '0');  // Months are zero-based
                        let year = date.getFullYear();
                        return `${day}/${month}/${year}`;
                    }
                    return timestamp;  // If not a number, return the original value
                }

                function calculateHoursAgo(datetimeStr) {
                    if (datetimeStr === "Processing") {
                        return "Processing";
                    }
                    let datetime = new Date(datetimeStr);
                    let now = new Date();
                    let diffInMs = now - datetime;
                    let diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
                    return `${diffInHours}h`;
                }
                $(document).on("click", ".toggle-active", function () {
                    let button = $(this);
                    let postId = button.data("post-id");
                    let newActive = !button.data("active");
                
                    $.ajax({
                        url: "{% url 'toggle-active' %}",
                        type: "POST",
                        data: JSON.stringify({ post_id: postId, active: newActive }),
                        contentType: "application/json",
                        headers: { "X-CSRFToken": getCSRFToken() },
                        success: function (response) {
                            if (response.success) {
                                // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                                button.data("active", newActive);
                                button.toggleClass("btn-success btn-secondary");
                                button.text(newActive);
                            } else {
                                alert(response.error);
                            }
                        },
                        error: function () {
                            alert("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i!");
                        }
                    });
                });
            });
            
        </script>
    </div>
</body>
</html>