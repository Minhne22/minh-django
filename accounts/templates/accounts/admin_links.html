<h3>üîó Qu·∫£n l√Ω Links</h3>

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <!-- jQuery & Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<!-- Th√™m Link -->
<div class="mb-3">
    <input type="text" id="post_id" placeholder="Nh·∫≠p ID Post" class="form-control mb-2">
    <button id="addLink" class="btn btn-success">‚ûï Th√™m Link</button>
</div>

<!-- B·∫£ng Links -->
<table class="table">
    <thead>
        <tr>
            <th>STT</th>
            <th>Time Created</th>
            <th>ID Post</th>
            <th>T√™n b√†i</th>
            <th>Th·ªùi gian cmt cu·ªëi</th>
            <th>Count Cmt</th>
            <th>Count Like</th>
            <th>Delay</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="linkTable"></tbody>
</table>

<!-- Modal Ch·ªânh s·ª≠a -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Ch·ªânh s·ª≠a Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPostId">

                <div class="mb-3">
                    <label for="editPostName" class="form-label">T√™n b√†i</label>
                    <input type="text" class="form-control" id="editPostName">
                </div>

                <div class="mb-3">
                    <label for="editLastCommentTime" class="form-label">Th·ªùi gian comment cu·ªëi</label>
                    <input type="text" class="form-control" id="editLastCommentTime">
                </div>
                

                <div class="mb-3">
                    <label for="editStatus" class="form-label">Tr·∫°ng th√°i</label>
                    <select class="form-select" id="editStatus">
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                        <option value="die">Die</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="editCommentCount" class="form-label">S·ªë l∆∞·ª£ng comment</label>
                    <input type="number" class="form-control" id="editCommentCount">
                </div>

                <div class="mb-3">
                    <label for="editLikeCount" class="form-label">S·ªë l∆∞·ª£ng like</label>
                    <input type="number" class="form-control" id="editLikeCount">
                </div>

                <div class="mb-3">
                    <label for="editDelay" class="form-label">Delay</label>
                    <input type="text" class="form-control" id="editDelay">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="saveEdit">L∆∞u</button>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () {
        function loadLinks() {
            $.get("{% url 'get_links' %}", function (data) {
                let rows = "";
                data.links.forEach((link, index) => {
                    let postLink = `<a href="https://www.facebook.com/${link.post_id}" target="_blank">${link.post_id}</a>`;
    
                    rows += `<tr>
                        <td>${index + 1}</td>
                        <td>${link.time_created}</td>
                        <td>${postLink}</td>
                        <td title="${link.content}">${link.post_name}</td>
                        <td>${link.last_comment_time}</td>
                        <td>${link.comment_count}</td>
                        <td>${link.like_count}</td>
                        <td>${link.delay}</td>
                        <td>${link.status}</td>
                        <td>
                            <button class="btn btn-warning edit-link" data-post-id="${link.post_id}">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger delete-link" data-post-id="${link.post_id}">‚ùå X√≥a</button>
                        </td>
                    </tr>`;
                });
                $("#linkTable").html(rows);
            }).done(function () {
                // BIND l·∫°i s·ª± ki·ªán click sau khi load data
                bindEvents();
            });
        }

        function bindEvents() {
            // M·ªü modal ch·ªânh s·ª≠a
            $(".edit-link").off("click").on("click", function () {
                let post_id = $(this).data("post-id");
    
                // L·∫•y th√¥ng tin t·ª´ b·∫£ng
                let row = $(this).closest("tr");
                $("#editPostId").val(post_id);
                $("#editPostName").val(row.find("td:eq(3)").text());
                $("#editLastCommentTime").val(row.find("td:eq(4)").text());
                $("#editCommentCount").val(row.find("td:eq(5)").text());
                $("#editLikeCount").val(row.find("td:eq(6)").text());
                $("#editDelay").val(row.find("td:eq(7)").text());
                $("#editStatus").val(row.find("td:eq(8)").text());
    
                $("#editModal").modal("show");
            });
        }

        loadLinks();

        // Th√™m link
        $("#addLink").click(function () {
            let post_id = $("#post_id").val();
            if (!post_id) {
                alert("Vui l√≤ng nh·∫≠p ID Post!");
                return;
            }

            $.post("{% url 'add_link' %}", JSON.stringify({ post_id }), function () {
                $("#post_id").val("");
                loadLinks();
            }, "json");
        });

        // X√≥a link
        $(document).on("click", ".delete-link", function () {
            let post_id = $(this).data("post-id");

            $.post("{% url 'delete_link' %}", JSON.stringify({ post_id: post_id }), function () {
                loadLinks();
            }, "json");
        });

        // M·ªü modal ch·ªânh s·ª≠a
        $(document).ready(function () {
            let editModal = new bootstrap.Modal(document.getElementById("editModal"));
        
            $(".edit-link").on("click", function () {
                let row = $(this).closest("tr");
        
                $("#editPostId").val($(this).data("post-id"));
                $("#editPostName").val(row.find("td:eq(3)").text());
                $("#editLastCommentTime").val(row.find("td:eq(4)").text().trim()); // L·∫•y th·ªùi gian comment cu·ªëi
                $("#editStatus").val(row.find("td:eq(8)").text().trim());
                $("#editCommentCount").val(row.find("td:eq(5)").text());
                $("#editLikeCount").val(row.find("td:eq(6)").text());
                $("#editDelay").val(row.find("td:eq(7)").text());
        
                editModal.show();
            });
        
            $("#saveEdit").on("click", function () {
                let postId = $("#editPostId").val();
                let newName = $("#editPostName").val();
                let newLastCommentTime = $("#editLastCommentTime").val(); // L·∫•y gi√° tr·ªã m·ªõi
                let newStatus = $("#editStatus").val();
                let newCommentCount = $("#editCommentCount").val();
                let newLikeCount = $("#editLikeCount").val();
                let newDelay = $("#editDelay").val();
        
                $.ajax({
                    url: "{% url 'edit_link' %}",
                    type: "POST",
                    data: JSON.stringify({
                        post_id: postId,
                        name: newName,
                        last_comment_time: newLastCommentTime, // G·ª≠i gi√° tr·ªã m·ªõi
                        status: newStatus,
                        comment_count: newCommentCount,
                        like_count: newLikeCount,
                        delay: newDelay
                    }),
                    contentType: "application/json",
                    headers: { "X-CSRFToken": getCSRFToken() },
                    success: function (response) {
                        if (response.success) {
                            // C·∫≠p nh·∫≠t tr·ª±c ti·∫øp d·ªØ li·ªáu tr√™n b·∫£ng
                            let row = $("tr[data-post-id='" + postId + "']");
                            row.find("td:eq(3)").text(newName);
                            row.find("td:eq(4)").text(newLastCommentTime);
                            row.find("td:eq(5)").text(newCommentCount);
                            row.find("td:eq(6)").text(newLikeCount);
                            row.find("td:eq(7)").text(newDelay);
                            row.find("td:eq(8)").text(newStatus);
                            
                            // ƒê√≥ng modal
                            editModal.hide();
                            loadLinks()
                        } else {
                            alert("L·ªói khi c·∫≠p nh·∫≠t!");
                        }
                    },
                    error: function (error) {
                        alert("L·ªói khi g·ª≠i d·ªØ li·ªáu!");
                    }
                });
            });
        
            function getCSRFToken() {
                return document.cookie.split('; ')
                    .find(row => row.startsWith('csrftoken'))
                    ?.split('=')[1];
            }
        });        
    });
</script>
