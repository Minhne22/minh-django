<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Links</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h3>üîó Qu·∫£n l√Ω Links</h3>

        <!-- Box hi·ªÉn th·ªã s·ªë links ƒë√£ c√≥ / limit_on -->
        <div class="alert alert-info" role="alert">
            <span id="linksCount">0</span> / <span id="limitOn">0</span> Links
        </div>

        <!-- Th√™m Link -->
        <div class="mb-3">
            <label for="multiLinks">Nh·∫≠p nhi·ªÅu links (m·ªói d√≤ng m·ªôt link):</label>
            <textarea id="multiLinks" class="form-control" rows="5" placeholder="D√°n c√°c link v√†o ƒë√¢y, m·ªói d√≤ng m·ªôt link..."></textarea>
            <button id="addLinksBtn" class="btn btn-primary mt-2">
                ‚ûïTh√™m Links
                <span id="addLinksSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
            </button>
        </div>

        <!-- Spinner hi·ªÉn th·ªã khi ƒëang t·∫£i -->
        <div id="loadingSpinner" class="text-center my-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- B·∫£ng Links -->
        <table class="table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Time Created</th>
                    <th>ID Post</th>
                    <th>T√™n B√†i</th>
                    <th>Th·ªùi Gian Cmt Cu·ªëi</th>
                    <th>Count Cmt</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="linkTable"></tbody>
        </table>

        <!-- Modal Ch·ªânh s·ª≠a -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Ch·ªânh s·ª≠a Link</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editPostId">

                        <div class="mb-3">
                            <label for="editPostName" class="form-label">T√™n b√†i</label>
                            <input type="text" class="form-control" id="editPostName">
                        </div>

                        <div class="mb-3">
                            <label for="editLastCommentTime" class="form-label">Th·ªùi gian comment cu·ªëi</label>
                            <input type="text" class="form-control" id="editLastCommentTime">
                        </div>

                        <div class="mb-3">
                            <label for="editStatus" class="form-label">Tr·∫°ng th√°i</label>
                            <select class="form-select" id="editStatus">
                                <option value="public">Public</option>
                                <option value="private">Private</option>
                                <option value="die">Die</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="editCommentCount" class="form-label">S·ªë l∆∞·ª£ng comment</label>
                            <input type="number" class="form-control" id="editCommentCount">
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                        <button type="button" class="btn btn-primary" id="saveEdit">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            $(document).ready(function () {
                function loadLinks() {
                    $.get("{% url 'get_links' %}", function (data) {
                        let rows = "";
                        data.links.forEach((link, index) => {
                            let postLink = `<a href="${link.origin_url}" target="_blank">${link.post_id}</a>`;
                            let formattedLastCommentTime = formatTimeDiff(link.last_comment_time);
                            rows += `<tr>
                                <td>${index + 1}</td>
                                <td>${link.created_time}</td>
                                <td>${postLink}</td>
                                <td>
                                    <span data-bs-toggle="tooltip" title="${link.content}">
                                        ${link.name}
                                    </span>
                                </td>
                                <td>${formattedLastCommentTime}</td>
                                <td>${link.comment_count}</td>
                                <td>${link.status}</td>
                                <td>
                                    <button class="btn btn-warning edit-link" data-post-id="${link.post_id}">‚úèÔ∏è Edit</button>
                                    <button class="btn btn-danger delete-link" data-post-id="${link.post_id}">‚ùå X√≥a</button>
                                </td>
                            </tr>`;
                        });
                        $("#linkTable").html(rows);
                        updateLinksCount(data.links.length);
                    }).done(function () {
                        // BIND l·∫°i s·ª± ki·ªán click sau khi load data
                        bindEvents();
                    });
                }

                function bindEvents() {
                    // M·ªü modal ch·ªânh s·ª≠a
                    $(".edit-link").off("click").on("click", function () {
                        let post_id = $(this).data("post-id");

                        // L·∫•y th√¥ng tin t·ª´ b·∫£ng
                        let row = $(this).closest("tr");
                        $("#editPostId").val(post_id);
                        $("#editPostName").val(row.find("td:eq(3)").text());
                        $("#editLastCommentTime").val(row.find("td:eq(4)").text());
                        $("#editCommentCount").val(row.find("td:eq(5)").text());
                        $("#editDelay").val(row.find("td:eq(7)").text());
                        $("#editStatus").val(row.find("td:eq(8)").text());

                        $("#editModal").modal("show");
                    });
                }

                function updateLinksCount(count) {
                    $("#linksCount").text(count);
                    $.get("{% url 'get_user_limit' %}", function (data) {
                        $("#limitOn").text(data.limit_on);
                    });
                }

                loadLinks();

                // Th√™m link
                $("#addLinksBtn").on("click", function () {
                    let links = $("#multiLinks").val().trim().split("\n").map(link => link.trim()).filter(link => link);

                    if (links.length === 0) {
                        alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt link!");
                        return;
                    }

                    $("#addLinksSpinner").show(); // Hi·ªán spinner

                    let tableBody = $("#linkTable");
                    links.forEach((link) => {
                        let newRow = `<tr data-post-id="">
                            <td>New</td>
                            <td>Processing...</td>
                            <td>${link}</td>
                            <td>Processing...</td>
                            <td>Processing...</td>
                            <td>Processing...</td>
                            <td>Processing...</td>
                            <td><span class="badge bg-warning">Processing</span></td>
                            <td>-</td>
                        </tr>`;
                        tableBody.append(newRow);
                    });

                    $.ajax({
                        url: "{% url 'add_links' %}",
                        type: "POST",
                        data: JSON.stringify({ links: links }),
                        contentType: "application/json",
                        headers: { "X-CSRFToken": getCSRFToken() },
                        success: function (response) {
                            if (response.success) {
                                reloadData();
                                $("#multiLinks").val("");
                            }
                        },
                        complete: function () {
                            $("#addLinksSpinner").hide(); // ·∫®n spinner sau khi x·ª≠ l√Ω xong
                        },
                        error: function () {
                            alert("L·ªói khi th√™m links!");
                        }
                    });
                });

                function getCSRFToken() {
                    return document.cookie.split('; ').find(row => row.startsWith('csrftoken'))?.split('=')[1];
                }

                function reloadData() {
                    $("#loadingSpinner").show(); // Hi·ªán spinner
                    $.ajax({
                        url: "{% url 'get_links' %}",
                        type: "GET",
                        success: function (response) {
                            if (response.success) {
                                let tableBody = $("#linkTable");
                                tableBody.empty();
                                response.links.forEach((link, index) => {
                                    let row = `<tr>
                                        <td>${index + 1}</td>
                                        <td>${link.created_time}</td>
                                        <td><a href="https://www.facebook.com/${link.post_id}" target="_blank">${link.post_id}</a></td>
                                        <td>
                                            <span data-bs-toggle="tooltip" title="${link.content}">
                                                ${link.name}
                                            </span>
                                        </td>
                                        <td>${link.last_comment_time}</td>
                                        <td>${link.comment_count}</td>
                                        <td><span class="badge ${link.status === 'public' ? 'bg-success' : 'bg-danger'}">${link.status}</span></td>
                                        <td>
                                            <button class="btn btn-warning edit-link" data-post-id="${link.post_id}">Edit</button>
                                            <button class="btn btn-danger delete-link" data-post-id="${link.post_id}">Delete</button>
                                        </td>
                                    </tr>`;
                                    tableBody.append(row);
                                });

                                $('[data-bs-toggle="tooltip"]').tooltip(); // C·∫≠p nh·∫≠t tooltip
                                updateLinksCount(response.links.length);
                            }
                        },
                        complete: function () {
                            $("#loadingSpinner").hide(); // ·∫®n spinner sau khi load xong
                        },
                        error: function () {
                            alert("Kh√¥ng th·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu!");
                            $("#loadingSpinner").hide(); // ·∫®n spinner n·∫øu c√≥ l·ªói
                        }
                    });
                }

                // X√≥a link
                $(document).on("click", ".delete-link", function () {
                    let post_id = $(this).data("post-id");

                    $(this).html('‚ùå X√≥a <span class="spinner-border spinner-border-sm" role="status"></span>');

                    $.post("{% url 'delete_link' %}", JSON.stringify({ post_id: post_id }), function () {
                        reloadData();
                    }, "json").always(function () {
                        $(this).html('‚ùå X√≥a');
                    });
                });

                // M·ªü modal ch·ªânh s·ª≠a
                let editModal = new bootstrap.Modal(document.getElementById("editModal"));

                $(".edit-link").on("click", function () {
                    let row = $(this).closest("tr");

                    $("#editPostId").val($(this).data("post-id"));
                    $("#editPostName").val(row.find("td:eq(3)").text());
                    $("#editLastCommentTime").val(row.find("td:eq(4)").text().trim()); // L·∫•y th·ªùi gian comment cu·ªëi
                    $("#editStatus").val(row.find("td:eq(8)").text().trim());
                    $("#editCommentCount").val(row.find("td:eq(5)").text());
                    $("#editDelay").val(row.find("td:eq(7)").text());

                    editModal.show();
                });

                $("#saveEdit").on("click", function () {
                    let postId = $("#editPostId").val();
                    let newName = $("#editPostName").val();
                    let newLastCommentTime = $("#editLastCommentTime").val();
                    let newStatus = $("#editStatus").val();
                    let newCommentCount = $("#editCommentCount").val();

                    $("#saveEditSpinner").show(); // Hi·ªán spinner

                    $.ajax({
                        url: "{% url 'edit_link' %}",
                        type: "POST",
                        data: JSON.stringify({
                            post_id: postId,
                            name: newName,
                            last_comment_time: newLastCommentTime,
                            status: newStatus,
                            comment_count: newCommentCount
                        }),
                        contentType: "application/json",
                        headers: { "X-CSRFToken": getCSRFToken() },
                        success: function (response) {
                            if (response.success) {
                                reloadData();
                                $("#editModal").modal("hide");
                            } else {
                                alert("L·ªói khi c·∫≠p nh·∫≠t!");
                            }
                        },
                        complete: function () {
                            $("#saveEditSpinner").hide(); // ·∫®n spinner sau khi x·ª≠ l√Ω xong
                        },
                        error: function () {
                            alert("L·ªói khi g·ª≠i d·ªØ li·ªáu!");
                        }
                    });
                });

                function getCSRFToken() {
                    return document.cookie.split('; ')
                        .find(row => row.startsWith('csrftoken'))
                        ?.split('=')[1];
                }
            });

            function formatTimeDiff(timestamp) {
                if (!isNaN(timestamp)) {
                    let currentTime = Math.floor(Date.now() / 1000);  // L·∫•y th·ªùi gian hi·ªán t·∫°i (UNIX timestamp)
                    let diffSeconds = currentTime - parseInt(timestamp);
                    let diffHours = Math.floor(diffSeconds / 3600);  // Chuy·ªÉn th√†nh gi·ªù
                    return diffHours + "h tr∆∞·ªõc";
                }
                return timestamp;  // N·∫øu kh√¥ng ph·∫£i s·ªë, gi·ªØ nguy√™n
            }
        </script>
    </div>
</body>
</html>